global
	log stdout format raw daemon
	maxconn 200
    tune.ssl.default-dh-param 2048
    stats socket 0.0.0.0:1999 level admin

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    # durée max qu'une requête peut rester en file d'attente côté HAProxy
    timeout queue 5s
    option  forwardfor
    # renvoyer la page d'attente quand HAProxy retourne 503
    errorloc 503 /waitlist

# Frontend: écoute HTTP et applique un rate-limit par IP
frontend http-in
    bind *:80
    option http-server-close

    # table de suivi par IP pour la limitation de débit
    stick-table type ip size 1m expire 10s store http_req_rate(10s)
    http-request track-sc0 src
    acl too_fast sc_http_req_rate(0) gt 20
    http-request deny status 429 if too_fast

    # uniquement /with-haproxy est proxifié vers le backend 'servers'
    acl is_with path_beg /with-haproxy

    # si le backend servers n'a plus de serveurs dispo
    acl servers_down nbsrv(servers) lt 1

    # pousser vers waitlist si on demande /with-haproxy ET que servers est down
    use_backend waitlist if is_with servers_down

    # permettre aussi l'accès direct à la page d'attente
    use_backend waitlist if { path_beg /waitlist }

    use_backend servers if is_with

    http-request deny status 404 unless is_with or { path_beg /waitlist }

# Backend: remplacer REPLACE_WITH_SERVER par l'IP/hostname du serveur S
backend servers
	balance roundrobin
	option httpchk GET /with-haproxy
	server S1 10.195.125.85:8000 maxconn 200 check

backend waitlist
    mode http
    server waitlist_app waitlist_app:8000
